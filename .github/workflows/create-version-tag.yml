# Creates a version tag for a given commit on the master branch

name: Create version tag

on:
  workflow_dispatch:
    inputs:
      commit:
        description: "SHA of the Commit to tag on the Master branch"
        required: true
      bump:
        description: "Version bump type"
        required: true
        default: "minor"
        type: choice
        options:
          - minor
          - major
      dry_run:
        description: "Dry run (the tag won't be pushed)"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  tag:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Fail if not on master
        run: |
          if [ "${GITHUB_REF_NAME}" != "master" ]; then
            echo "This workflow may only be run from master"
            exit 1
          fi
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch the master branch
        run: |
          git fetch origin master:refs/remotes/origin/master

      - name: Verify that the commit is on the master branch
        run: |
          commit="${{ inputs.commit }}"

          if ! git merge-base --is-ancestor "$commit" origin/master; then
            echo "::error::Commit $commit is not reachable from master"
            exit 1
          fi

      - name: Get the last tag from the master branch
        id: latest
        run: |
          latest_tag=$(git tag --merged origin/master --sort=-creatordate | head -n 1 || echo "0.0")
          
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Latest tag on master: $latest_tag"

      - name: Verify that the commit is newer than the last tagged commit
        run: |
          commit="${{ inputs.commit }}"
          last_commit_tag="${{ steps.latest.outputs.latest_tag }}"

          # Skip check if this is the first tag
          if [ "$latest_tag" = "0.0" ]; then
            echo "No previous tag on master; skipping age check"
            exit 0
          fi

          # Get commit timestamps (seconds since epoch)
          tagged_time=$(git show -s --format=%ct "$last_commit_tag")
          target_commit_time=$(git show -s --format=%ct "$commit")

          tagged_commit_hash=$(git rev-parse "$last_commit_tag")
          tagged_commit_hash_short=$(git rev-parse --short "$last_commit_tag")

          if [ "$target_commit_time" -le "$tagged_time" ]; then
            echo "::error::Commit $commit is older than or equal to the last tagged commit ($last_commit_tag - $tagged_commit_hash / $tagged_commit_hash_short)"
            exit 1
          fi


          echo "OK: Commit $commit is newer than last tagged commit $last_commit_tag ($tagged_commit_hash / $tagged_commit_hash_short)"
      - name: Validate latest tag (must be of {number}.{number} format)
        run: |
          latest="${{ steps.latest.outputs.latest_tag }}"

          if ! [[ "$latest" =~ ^[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Latest tag '$latest' does not match required format <number>.<number>"
            exit 1
          fi

      - name: Calculate next version
        id: next
        run: |
          latest="${{ steps.latest.outputs.latest_tag }}"
          bump="${{ inputs.bump }}"

          major=$(echo "$latest" | cut -d. -f1)
          minor=$(echo "$latest" | cut -d. -f2)

          if [ "$bump" = "major" ]; then
            major=$((major + 1))
            minor=0
          else
            minor=$((minor + 1))
          fi

          next_version="$major.$minor"
          echo "next_version=$next_version" >> $GITHUB_OUTPUT
          echo "Next version: $next_version"

      - name: Fail if the tag already exists
        run: |
          tag="${{ steps.next.outputs.next_version }}"

          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "::error::Tag '$tag' already exists"
            exit 1
          fi

      - name: Dry Run Summary
        if: inputs.dry_run == 'true'
        run: |
          echo "DRY RUN"
          echo "Commit: ${{ inputs.commit }}"
          echo "Latest tag: ${{ steps.latest.outputs.latest_tag }}"
          echo "Next tag: ${{ steps.next.outputs.next_version }}"
          echo "Commit is reachable from main and the tag does not exist."

      - name: Create and Push the tag
        if: inputs.dry_run == 'false'
        run: |
          git tag "${{ steps.next.outputs.next_version }}" "${{ inputs.commit }}"
          git push origin "${{ steps.next.outputs.next_version }}"
